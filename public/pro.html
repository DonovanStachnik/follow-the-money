<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FollowTheMoney • Pro</title>
  <style>
    :root { --bg:#0f172a; --panel:#0b1220; --border:#1f2937; --muted:#9ca3af; --txt:#e5e7eb; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font-family:ui-sans-serif,system-ui,-apple-system}
    header{background:#0b1220;border-bottom:1px solid var(--border)}
    .nav{max-width:1400px;margin:0 auto;padding:14px 18px;display:flex;gap:16px;align-items:center}
    .brand{font-weight:800;letter-spacing:.3px;display:flex;align-items:center;gap:10px}
    .brand img{width:22px;height:22px}
    .nav a{color:#e5e7eb;text-decoration:none;margin-right:14px}
    .wrap{max-width:1400px;margin:0 auto;padding:22px 18px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input,select,button{background:var(--panel);color:var(--txt);border:1px solid var(--border);padding:9px 10px;border-radius:10px}
    button{cursor:pointer}
    .status{color:var(--muted);margin-left:8px}
    .gridwrap{display:grid;grid-template-columns: 1fr 340px; gap:16px; align-items:start}
    .columns{display:grid;grid-template-columns:repeat(4, minmax(180px, 1fr)); gap:12px}
    .col{background:var(--panel);border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .col .head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);color:#cbd5e1;font-weight:700}
    .strike{display:flex;justify-content:space-between;padding:8px 12px;border-bottom:1px dashed var(--border);font-variant-numeric:tabular-nums}
    .bad{background:#3b0764} .good{background:#064e3b}
    .strike.bad{background:linear-gradient(90deg, rgba(59,7,100,0.22), transparent)}
    .strike.good{background:linear-gradient(90deg, rgba(6,78,59,0.22), transparent)}
    .flow{background:var(--panel);border:1px solid var(--border);border-radius:14px;max-height:75vh;overflow:auto}
    .flow .head{position:sticky;top:0;background:var(--panel);z-index:1;border-bottom:1px solid var(--border);padding:10px 12px;font-weight:700}
    .item{display:flex;justify-content:space-between;gap:10px;padding:10px 12px;border-bottom:1px dashed var(--border);font-variant-numeric:tabular-nums}
    .badge{font-size:12px;padding:3px 8px;border-radius:999px;display:inline-block;margin-right:6px}
    .call{background:#065f46;color:#bbf7d0}.put{background:#6d28d9;color:#f5d0fe}
    small.note{display:block;color:var(--muted);padding:6px 12px}
    .hint{color:var(--muted);font-size:12px;margin:6px 2px}
  </style>
</head>
<body>
  <header><div class="nav">
    <div class="brand"><img src="/logo.svg" alt="logo"/><span>FollowTheMoney</span></div>
    <nav><a href="/index.html">Home</a><a href="/pro.html">Pro</a><a href="/disclaimer.html">Disclaimer</a></nav>
  </div></header>

  <div class="wrap">
    <h1 style="margin:6px 0 10px">Pro — Heatmap & Flow</h1>
    <div class="row">
      <label>Ticker <input id="ticker" value="AAPL" style="width:120px"></label>
      <label>Expiry <select id="expiry" style="min-width:160px"></select></label>
      <button id="search">Search</button>
      <span id="status" class="status"></span>
    </div>

    <div class="hint">Source: <code>/api/grid2</code> (multi-expiry) and <code>/api/flow2</code>. Positive = net call premium, Negative = net put premium.</div>

    <div class="gridwrap">
      <div>
        <div id="columns" class="columns"></div>
      </div>
      <div class="flow">
        <div class="head">Options Flow <span id="flowCount" style="color:var(--muted);font-weight:400"></span></div>
        <div id="flowList"></div>
        <small class="note">Source: /api/flow2.</small>
      </div>
    </div>
  </div>

<script>
const \$ = s => document.querySelector(s);
const fmt = n => {
  const a = Math.abs(n);
  if (a >= 1e9) return (n/1e9).toFixed(1)+'B';
  if (a >= 1e6) return (n/1e6).toFixed(1)+'M';
  if (a >= 1e3) return (n/1e3).toFixed(1)+'K';
  return (Math.round(n)).toString();
};

async function j(url) {
  const r = await fetch(url, {cache:'no-store'});
  if (!r.ok) throw new Error(HTTP :  + await r.text());
  return r.json();
}

async function loadExpirations(symbol) {
  const s = await j(/api/search?ticker=\);
  const sel = \#expiry; sel.innerHTML = '';
  (s.expirations || []).forEach(d => {
    const o = document.createElement('option'); o.value = d; o.textContent = d; sel.appendChild(o);
  });
  if (sel.options.length) sel.selectedIndex = 0;
}

function strikeRow(strike, value) {
  const div = document.createElement('div');
  const cls = value > 0 ? 'good' : (value < 0 ? 'bad' : '');
  div.className = 'strike ' + cls;
  const left = document.createElement('div');
  left.textContent = strike;
  const right = document.createElement('div');
  right.textContent = (value>=0?'$ ':'-$ ') + fmt(Math.abs(value));
  div.appendChild(left); div.appendChild(right);
  return div;
}

async function renderColumns(symbol, startDate=null) {
  const exps = Array.from(\#expiry.options).map(o => o.value);
  const pick = (startDate && exps.includes(startDate))
    ? [startDate, ...exps.filter(d=>d!==startDate)]
    : exps;
  const chosen = pick.slice(0,4);

  const mount = \#columns; mount.innerHTML = '';
  await Promise.all(chosen.map(async (date) => {
    const data = await j(/api/grid2?ticker=\&date=\&rows=18&limit=1500);
    const col = document.createElement('div'); col.className='col';
    const head = document.createElement('div'); head.className='head';
    head.innerHTML = <span>\</span><span style="font-size:11px;color:#94a3b8">NET</span>;
    col.appendChild(head);
    (data.netMatrix||[]).forEach(row => col.appendChild(strikeRow(row.strike, row.value)));
    mount.appendChild(col);
  }));
}

async function renderFlow(symbol, date) {
  const f = await j(/api/flow2?ticker=\&date=\&limit=60);
  const list = \#flowList; list.innerHTML = '';
  \#flowCount.textContent = f.count ? \(\ items)\ : '';
  (f.items||[]).forEach(it => {
    const row = document.createElement('div'); row.className='item';
    const left = document.createElement('div');
    const badge = document.createElement('span'); badge.className = 'badge ' + (it.side==='CALL'?'call':'put'); badge.textContent = it.side;
    left.appendChild(badge);
    const meta = document.createElement('span');
    meta.innerHTML = \Strike <b>\</b> <span style="color:#94a3b8">Vol \ OI \</span>\;
    left.appendChild(meta);
    const right = document.createElement('div'); right.textContent = '\$' + fmt(it.premium);
    row.appendChild(left); row.appendChild(right);
    list.appendChild(row);
  });
}

async function go() {
  try{
    const sym = \#ticker.value.trim().toUpperCase();
    \#status.textContent = 'Loading…';
    await loadExpirations(sym);
    const date = \#expiry.value || '';
    await renderColumns(sym, date);
    await renderFlow(sym, date);
    \#status.textContent = \OK • \ • \ • \\;
  } catch(e){
    console.error(e);
    \#status.textContent = 'Error: ' + (e.message||e);
  }
}

document.getElementById('search').addEventListener('click', go);
document.getElementById('expiry').addEventListener('change', go);
document.getElementById('ticker').addEventListener('keydown', e => { if (e.key==='Enter') go(); });

go();
</script>
</body>
</html>
